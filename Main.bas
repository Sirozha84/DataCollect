Attribute VB_Name = "Main"
Public Const isRelease = True   'True - полноценная работа, False - режим отладки (нет вопросов, нет записи в файлы)
Public Const saveSource = True  'True - сохранение данных в формах, False - данные не записываются (отладка)

Public Const Secret = "123"     'Пароль для защиты

Public Const maxRow = 1048576   'Последняя строка везде (для очистки)
Public Const tmpVersion = "20210108"    'Версия реестра

'Колонки "Отгрузки"
Public Const cUIN = 1           'УИН
Public Const cDates = 2         'Дата
Public Const cBuyINN = 3        'ИНН покупателя
Public Const cBuyer = 4         'Наименование покупателя
Public Const cSellINN = 5       'ИНН продавца
Public Const cSeller = 6        'Наименование продавец
Public Const cPrice = 7         'Стоимость с НДС
Public Const cCom = 15          'Комментарий
Public Const cStatus = 16       'Статус
Public Const cDateCol = 17      'Дата сбора
Public Const cFile = 18         'Имя файла
Public Const cCode = 19         'Код формы
Public Const cAccept = 20       'Принято/не принято

'Колонки "Поступления"
Public Const clFile = 17        'Имя файла

'Колонки "Справочник"
Public Const cSellerName = 1    'Наименование продавца
Public Const cINN = 2           'ИНН
Public Const cSDate = 3         'Дата регистрации
Public Const cGroup = 4         'Группы
Public Const cPLiter = 6        'Префикс - литер
Public Const cPCode = 7         'Префикс - код
Public Const cPND = 8
Public Const cPStat = 9         'Статус
Public Const cLimits = 10       'Первая колонка с остатками
Public Const cPFact = 22        'Первая колонка с фактическими объёмами
Public Const cPBalance = 34     'Первая колонка с остатками (*2)
Public Const cPRev = 70         'Первая колонка с фактическими отгрузками (для ревизии остатков)
Public Const quartCount = 12    'Количество кварталов в расчётах лимитов
Public Const lastYear = 2020    'Первый расчётный год (потом это будет переменной, но пока статика)
Public Const lastQuartal = 4    'Первыё расчётный квартал (аналогично)

'Колонки "Шаблоны"
Public Const cTClient = 1       'Клиент
Public Const cTBroker = 2       'Посредник
Public Const cTForm = 3         'Форма
Public Const cTCode = 4         'Код
Public Const cTFile = 5         'Файл
Public Const cTResult = 6       'Результат
Public Const cTStat = 7         'Статус

'Первые строки
Public Const firstDat = 6       'Отгрузки
Public Const firstDtL = 6       'Поступления
Public Const firstSrc = 5       'Реестры
Public Const firstTempl = 6     'Список шаблонов
Public Const firstDic = 4       'Справочник
Public Const firstErr = 2       'Ошибки
Public Const firstNum = 4       'Словарь нумератора
Public Const firstValues = 6    'Отчёт "Объёмы"

'Строки с параметрами
Public Const pImportSale = 4    'Импорт отгрузок
Public Const pImportLoad = 5    'Импорт поступлений
Public Const pExport = 6        'Экспорт

'Цвета
Public colWhite As Long
Public colRed As Long
Public colGreen As Long
Public colYellow As Long
Public colGray As Long
Public colBlue As Long

'Ссылки на таблицы
Public DAT As Variant           'Данные о продажах
Public DTL As Variant           'Данные о поступлениях
Public SRC As Variant           'Исходные данные
Public DIC As Variant           'Справочники
Public ERR As Variant           'Список ошибок
Public NUM As Variant           'Словарь нумератора
Public VAL As Variant           'Значения объёмов
Public VLS As Variant           'Сводная таблица
Public TMP As Variant           'Шаблоны
Public SBK As Variant           'Книги продаж
Public PRP As Variant           'Настройки

'Настройки
Public DirImportSale As String  'Каталог импорта отгрузок
Public DirImportLoad As String  'Каталог импорта поступлений
Public DirExport As String      'Каталог экспорта

'Общие переменные
Public selIndexes As Variant    'Словарь индексов продавцов (номера строк в справочнике по ИНН)
Public BookCount As Long        'Счётчик сгенерированных книг

'Инициализация таблиц, цветов
Sub Init()
    colWhite = RGB(255, 255, 255)
    colRed = RGB(255, 192, 192)
    colGreen = RGB(192, 255, 192)
    colYellow = RGB(255, 255, 192)
    colGray = RGB(217, 217, 217)
    colBlue = RGB(192, 217, 255)
    
    If isRelease Then On Error GoTo er
    Set DAT = Sheets("Отгрузки")
    Set DTL = Sheets("Поступления")
    Set DIC = Sheets("Справочник")
    Set VAL = Sheets("Объёмы")
    Set VLS = Sheets("Сводная таблица")
    Set TMP = Sheets("Шаблоны")
    Set SBK = Sheets("Книги продаж")
    Set ERR = Sheets("Ошибки")
    Set NUM = Sheets("Нумератор")
    Set PRP = Sheets("Настройки")
    
    DirImportSale = PRP.Cells(pImportSale, 2).text
    DirImportLoad = PRP.Cells(pImportLoad, 2).text
    DirExport = PRP.Cells(pExport, 2).text
    
    Exit Sub
er:
    MsgBox ("Ошибка целостности документа! Необходимые вкладки были удалены или переименовены.")
    End
End Sub

Sub ButtonProperties()
    Init
    FormProperties.Show
End Sub

'******************** Вкладка "Отгрузки" ********************

'Кнопка "Сбор данных"
Sub ButtonDataCollect()
    Init
    If isRelease Then If MsgBox("Начинается сбор данных по отгрузкам. Продолжить?", vbYesNo) = vbNo Then Exit Sub
    Message "Подготовка..."
    SetProtect DAT
    CollectSale.Run
    DAT.Activate
End Sub

'Кнопка "Экспорт в 1С"
Sub ButtonExport()
    Init
    FormExport.Show
End Sub

'Кнопка "Удаление данных"
Sub ButtonClear()
    Init
    If isRelease Then
        e = Chr(10)
        If InputBox("Внимание! " + e + e + _
            "Данная процедура очистит все собранные данные. " + _
            "Уже зарегистрированные данные при повторной регистрации могут присвоить другой код. " + _
            "Справочник и словари нумератора удаляться не будут." + e + e + _
            "Для продолжения введите пароль.", "Удаление данных") <> Secret Then Exit Sub
    End If
    SetProtect DAT
    Range(Cells(firstDat, 1), Cells(maxRow, cAccept)).Clear
    Range(Cells(firstDat, cStatus), Cells(maxRow, cDateCol)).Interior.Color = colYellow
    Range(Cells(firstDat, cFile), Cells(maxRow, cAccept)).Interior.Color = colGray
    Range(Cells(firstDat, cFile), Cells(maxRow, cAccept)).Font.Color = RGB(166, 166, 166)
    Range(DIC.Cells(firstDic, cPFact), DIC.Cells(maxRow, cPFact + quartCount - 1)).Clear
    Message "Готово!"
End Sub

'******************** Вкладка "Поступления" ********************

'Кнопка "Сбор поступлений"
Sub ButtonCollectLoad()
    Init
    If isRelease Then If MsgBox("Начинается сбор данных по поступлениям. " + _
        "Начала этого процесса очистит уже собранные данные. Продолжить?", vbYesNo) = vbNo Then Exit Sub
    Message "Подготовка..."
    CollectLoad.Run
    DTL.Activate
End Sub

'Кнопка "Экспорт поступлений в 1С"
Sub ButtonExportLoad()

End Sub

'******************** Вкладка "Объёмы" ********************

'Кнопка ревизии остатков
Sub ButtonRevisionVolumes()
    Init
    Revision.Run
End Sub

'Кнопка "Сформировать отчёт" по объёмам
Sub ButtonReportVolumes()
    Init
    Values.CreateReport
    VAL.Activate
End Sub

'******************** Вкладка "Шаблоны" ********************

'Кнопка "Генерировать шаблоны"
Sub ButtonCreateTemplates()
    Init
    Template.Generate
End Sub

'******************** Вкладка "Книги продаж" ********************

'Кнопка "Сформировать"
Public Sub ButtonSellBook()
    Init
    SellBook.Run
End Sub